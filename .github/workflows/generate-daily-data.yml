name: ç”Ÿæˆæ¯æ—¥CVEæ•°æ®å¹¶æ›´æ–°ç»Ÿè®¡

on:
  schedule:
    # æ¯å¤©åŒ—äº¬æ—¶é—´æ—©ä¸Š8ç‚¹è¿è¡Œ (UTC 00:00)
    - cron: '0 0 * * *'
  push:
    branches: [main]
    paths:
      - 'docs/README.md'
      - 'scripts/enhanced_daily_data_generator.py'
  workflow_dispatch:
    inputs:
      fill_gaps:
        description: 'æ˜¯å¦å¡«è¡¥ç¼ºå¤±æ—¥æœŸ'
        required: false
        default: true
        type: boolean
      start_date:
        description: 'å¼€å§‹æ—¥æœŸ (YYYY-MM-DDï¼Œå¯é€‰)'
        required: false
        type: string
      end_date:
        description: 'ç»“æŸæ—¥æœŸ (YYYY-MM-DDï¼Œå¯é€‰)'
        required: false
        type: string

jobs:
  generate-daily-data:
    runs-on: ubuntu-latest
    
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        fetch-depth: 0
    
    - name: è®¾ç½®PythonçŽ¯å¢ƒ
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'
    
    - name: å®‰è£…ä¾èµ–
      run: |
        python -m pip install --upgrade pip
        # å¦‚æžœæœ‰requirements.txtæ–‡ä»¶çš„è¯
        if [ -f requirements.txt ]; then pip install -r requirements.txt; fi
    
    - name: è¿è¡Œå¢žå¼ºç‰ˆæ•°æ®ç”Ÿæˆå™¨
      run: |
        cd scripts
        python enhanced_daily_data_generator.py \
          --readme ../docs/README.md \
          --output ../docs/Data/daily \
          ${{ github.event.inputs.fill_gaps == 'true' && '--fill-gaps' || '' }} \
          ${{ github.event.inputs.start_date && format('--start-date {0}', github.event.inputs.start_date) || '' }} \
          ${{ github.event.inputs.end_date && format('--end-date {0}', github.event.inputs.end_date) || '' }} \
          --verbose
    
    # - name: æ£€æŸ¥æ˜¯å¦æœ‰å˜æ›´
    #   id: check_changes
    #   run: |
    #     if git diff --quiet HEAD -- docs/Data/daily/; then
    #       echo "changes=false" >> $GITHUB_OUTPUT
    #       echo "ðŸ“ æ²¡æœ‰æ£€æµ‹åˆ°æ•°æ®å˜æ›´"
    #     else
    #       echo "changes=true" >> $GITHUB_OUTPUT
    #       echo "âœ… æ£€æµ‹åˆ°æ•°æ®å˜æ›´"
    #     fi
    
    - name: æäº¤å’ŒæŽ¨é€å˜æ›´
      if: steps.check_changes.outputs.changes == 'true'
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        
        # æ·»åŠ æ‰€æœ‰å˜æ›´çš„æ–‡ä»¶
        git add docs/Data/daily/
        
        # èŽ·å–å½“å‰æ—¥æœŸ
        CURRENT_DATE=$(date '+%Y-%m-%d')
        
        # ç»Ÿè®¡æ–°å¢žæ–‡ä»¶æ•°é‡
        NEW_FILES=$(git diff --cached --name-only --diff-filter=A | wc -l)
        MODIFIED_FILES=$(git diff --cached --name-only --diff-filter=M | wc -l)
        
        # åˆ›å»ºæäº¤ä¿¡æ¯
        COMMIT_MSG="ðŸ¤– è‡ªåŠ¨æ›´æ–°æ¯æ—¥CVEæ•°æ® ($CURRENT_DATE)"
        if [ "$NEW_FILES" -gt 0 ]; then
          COMMIT_MSG="$COMMIT_MSG - æ–°å¢ž $NEW_FILES ä¸ªæ–‡ä»¶"
        fi
        if [ "$MODIFIED_FILES" -gt 0 ]; then
          COMMIT_MSG="$COMMIT_MSG - æ›´æ–° $MODIFIED_FILES ä¸ªæ–‡ä»¶"
        fi
        
        git commit -m "$COMMIT_MSG"
        git push
    
    - name: ç”Ÿæˆè¿è¡ŒæŠ¥å‘Š
      if: always()
      run: |
        echo "## ðŸ“Š æ¯æ—¥CVEæ•°æ®ç”ŸæˆæŠ¥å‘Š" >> $GITHUB_STEP_SUMMARY
        echo "| é¡¹ç›® | çŠ¶æ€ | è¯¦æƒ… |" >> $GITHUB_STEP_SUMMARY
        echo "|------|------|------|" >> $GITHUB_STEP_SUMMARY
        echo "| è„šæœ¬æ‰§è¡Œ | âœ… æˆåŠŸ | å¢žå¼ºç‰ˆæ•°æ®ç”Ÿæˆå™¨è¿è¡Œå®Œæˆ |" >> $GITHUB_STEP_SUMMARY
        
        if [ "${{ steps.check_changes.outputs.changes }}" == "true" ]; then
          echo "| æ•°æ®æ›´æ–° | âœ… æœ‰æ›´æ–° | æ£€æµ‹åˆ°æ–°æ•°æ®å¹¶å·²æäº¤ |" >> $GITHUB_STEP_SUMMARY
        else
          echo "| æ•°æ®æ›´æ–° | â„¹ï¸ æ— å˜æ›´ | æœªæ£€æµ‹åˆ°æ–°æ•°æ® |" >> $GITHUB_STEP_SUMMARY
        fi
        
        # æ˜¾ç¤ºæœ€æ–°çš„æ±‡æ€»ç»Ÿè®¡
        if [ -f "docs/Data/daily/daily_summary.json" ]; then
          TOTAL_CVES=$(python3 -c "import json; data=json.load(open('docs/Data/daily/daily_summary.json')); print(data['total_cves'])")
          TOTAL_FILES=$(python3 -c "import json; data=json.load(open('docs/Data/daily/daily_summary.json')); print(data['total_files'])")
          DATE_RANGE_START=$(python3 -c "import json; data=json.load(open('docs/Data/daily/daily_summary.json')); print(data['date_range']['start'])")
          DATE_RANGE_END=$(python3 -c "import json; data=json.load(open('docs/Data/daily/daily_summary.json')); print(data['date_range']['end'])")
          
          echo "| æ€»CVEæ•°é‡ | ðŸ“Š $TOTAL_CVES | ç´¯è®¡è®°å½•æ•° |" >> $GITHUB_STEP_SUMMARY
          echo "| æ€»æ–‡ä»¶æ•° | ðŸ“ $TOTAL_FILES | ç”Ÿæˆçš„JSONæ–‡ä»¶æ•° |" >> $GITHUB_STEP_SUMMARY
          echo "| æ—¥æœŸèŒƒå›´ | ðŸ“… $DATE_RANGE_START åˆ° $DATE_RANGE_END | æ•°æ®è¦†ç›–æ—¶é—´æ®µ |" >> $GITHUB_STEP_SUMMARY
        fi
        
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "ðŸ”— **ç›¸å…³é“¾æŽ¥:**" >> $GITHUB_STEP_SUMMARY
        echo "- [ç»Ÿè®¡é¡µé¢](https://adminlove520.github.io/github_cve_monitor/stats.html)" >> $GITHUB_STEP_SUMMARY
        echo "- [æ•°æ®ç›®å½•](https://github.com/${{ github.repository }}/tree/main/docs/Data/daily)" >> $GITHUB_STEP_SUMMARY