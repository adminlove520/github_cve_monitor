name: éƒ¨ç½²å‰ç«¯é…ç½®

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  deploy-config:
    runs-on: ubuntu-latest
    
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
    
    - name: ç”Ÿæˆå‰ç«¯é…ç½®æ–‡ä»¶
      run: |
        # ä¸ºdocsç›®å½•ç”Ÿæˆconfig.json
        cat > docs/config.json << EOF
        {
          "github_token": "${{ secrets.GH_TOKEN }}",
          "api_base_url": "https://api.github.com",
          "repository": "adminlove520/github_cve_monitor",
          "generated_at": "$(date -u '+%Y-%m-%dT%H:%M:%SZ')"
        }
        EOF
        
        # ä¸ºdocs/Dataç›®å½•ä¹Ÿç”Ÿæˆä¸€ä¸ªconfig.json
        cat > docs/Data/config.json << EOF
        {
          "github_token": "${{ secrets.GH_TOKEN }}",
          "api_base_url": "https://api.github.com",
          "repository": "adminlove520/github_cve_monitor",
          "generated_at": "$(date -u '+%Y-%m-%dT%H:%M:%SZ')"
        }
        EOF
        
        echo "âœ… é…ç½®æ–‡ä»¶ç”Ÿæˆå®Œæˆ"
        echo "ðŸ“„ docs/config.json"
        echo "ðŸ“„ docs/Data/config.json"
    
    - name: æäº¤é…ç½®æ–‡ä»¶
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        
        if git diff --quiet HEAD -- docs/config.json docs/Data/config.json; then
          echo "ðŸ“ é…ç½®æ–‡ä»¶æ— å˜æ›´"
        else
          git add docs/config.json docs/Data/config.json
          git commit -m "ðŸ”§ æ›´æ–°å‰ç«¯é…ç½®æ–‡ä»¶ [skip ci]"
          git push
          echo "âœ… é…ç½®æ–‡ä»¶å·²æ›´æ–°å¹¶æäº¤"
        fi
    
    - name: ç”Ÿæˆéƒ¨ç½²æŠ¥å‘Š
      if: always()
      run: |
        echo "## ðŸ”§ å‰ç«¯é…ç½®éƒ¨ç½²æŠ¥å‘Š" >> $GITHUB_STEP_SUMMARY
        echo "| é¡¹ç›® | çŠ¶æ€ | è¯¦æƒ… |" >> $GITHUB_STEP_SUMMARY
        echo "|------|------|------|" >> $GITHUB_STEP_SUMMARY
        echo "| é…ç½®ç”Ÿæˆ | âœ… æˆåŠŸ | å‰ç«¯é…ç½®æ–‡ä»¶å·²ç”Ÿæˆ |" >> $GITHUB_STEP_SUMMARY
        echo "| å®‰å…¨æ€§ | ðŸ”’ å®‰å…¨ | Tokené€šè¿‡GitHub Secretså®‰å…¨ä¼ é€’ |" >> $GITHUB_STEP_SUMMARY
        echo "| éƒ¨ç½²ä½ç½® | ðŸ“ å¤šä½ç½® | docs/ å’Œ docs/Data/ ç›®å½• |" >> $GITHUB_STEP_SUMMARY
        
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "ðŸ”— **ç›¸å…³é“¾æŽ¥:**" >> $GITHUB_STEP_SUMMARY
        echo "- [ç»Ÿè®¡é¡µé¢](https://adminlove520.github.io/github_cve_monitor/stats.html)" >> $GITHUB_STEP_SUMMARY
        echo "- [æ¯æ—¥æŠ¥å‘Š](https://adminlove520.github.io/github_cve_monitor/Data/)" >> $GITHUB_STEP_SUMMARY